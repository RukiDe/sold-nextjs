// prisma/schema.prisma

generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
}

model Brand {
  id              String   @id @default(cuid())
  code            String   @unique
  name            String
  logoUrl         String?
  sourceType      String
  status          String   @default("active")
  priority        Int      @default(0)
  registerBaseUrl String?
  apiBaseUrl      String?

  createdAt       DateTime @default(now())
  updatedAt       DateTime @updatedAt

  products        Product[]
  productIndexes  ProductIndex[]
  rawProducts     RawProduct[]
}

model ProductIndex {
  id                String   @id @default(cuid())
  brandCode         String
  brandName         String
  productExternalId String
  prdUrl            String
  lastModified      String?
  lastSeenAt        DateTime @default(now())
  lastHash          String?

  brand             Brand?   @relation(fields: [brandCode], references: [code])

  @@unique([brandCode, productExternalId], name: "brand_product_external_unique")
  @@index([brandCode])
}

model RawProduct {
  id                String   @id @default(cuid())
  brandCode         String
  productExternalId String
  source            String
  payload           Json
  hash              String
  fetchedAt         DateTime @default(now())

  brand             Brand?   @relation(fields: [brandCode], references: [code])

  @@index([brandCode, productExternalId])
}

model Product {
  id               String   @id @default(cuid())
  brandId          String
  externalId       String
  name             String

  channel          String
  purpose          String
  ownerTypes       String
  repaymentTypes   String

  isActive         Boolean  @default(true)

  createdAt        DateTime @default(now())
  updatedAt        DateTime @updatedAt

  brand            Brand    @relation(fields: [brandId], references: [id])
  rates            ProductRate[]

  @@index([externalId])
  @@index([brandId])
}

model ProductRate {
  id               String   @id @default(cuid())
  productId        String
  lvrMax           Float
  rateType         String
  annualRate       Float
  comparisonRate   Float?
  fixedTermMonths  Int?
  revertAnnualRate Float?

  effectiveFrom    DateTime @default(now())
  effectiveTo      DateTime?

  product          Product  @relation(fields: [productId], references: [id])

  @@index([productId])
  @@index([effectiveFrom])
}
